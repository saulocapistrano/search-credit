<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="008" author="saulocapistrano">
        <!-- Adicionar colunas de workflow à tabela credito -->
        
        <!-- Status: NOT NULL com DEFAULT 'CONSTITUIDO' para créditos existentes -->
        <addColumn tableName="credito">
            <column name="status" type="VARCHAR(20)" defaultValue="CONSTITUIDO">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Nome do solicitante: NULLABLE -->
        <addColumn tableName="credito">
            <column name="nome_solicitante" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- URL do comprovante: NULLABLE -->
        <addColumn tableName="credito">
            <column name="comprovante_url" type="VARCHAR(500)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Data da solicitação: NULLABLE -->
        <addColumn tableName="credito">
            <column name="data_solicitacao" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Comentário da análise: NULLABLE -->
        <addColumn tableName="credito">
            <column name="comentario_analise" type="TEXT">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Data da análise: NULLABLE -->
        <addColumn tableName="credito">
            <column name="data_analise" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Garantir que créditos existentes recebam status CONSTITUIDO -->
        <sql>
            UPDATE credito SET status = 'CONSTITUIDO' WHERE status IS NULL;
        </sql>

        <!-- Criar índice em credito.status -->
        <createIndex
                indexName="idx_credito_status"
                tableName="credito">
            <column name="status"/>
        </createIndex>

        <!-- Criar índice em credito.nome_solicitante -->
        <createIndex
                indexName="idx_credito_nome_solicitante"
                tableName="credito">
            <column name="nome_solicitante"/>
        </createIndex>

        <rollback>
            <dropIndex indexName="idx_credito_nome_solicitante" tableName="credito"/>
            <dropIndex indexName="idx_credito_status" tableName="credito"/>
            <dropColumn tableName="credito" columnName="data_analise"/>
            <dropColumn tableName="credito" columnName="comentario_analise"/>
            <dropColumn tableName="credito" columnName="data_solicitacao"/>
            <dropColumn tableName="credito" columnName="comprovante_url"/>
            <dropColumn tableName="credito" columnName="nome_solicitante"/>
            <dropColumn tableName="credito" columnName="status"/>
        </rollback>
    </changeSet>

</databaseChangeLog>

