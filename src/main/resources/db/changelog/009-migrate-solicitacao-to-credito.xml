<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="009" author="saulocapistrano">
        <!-- Migrar dados de solicitacao_credito para credito -->
        <!-- Apenas registros que ainda não existem em credito (baseado em numero_credito) -->
        
        <sql>
            INSERT INTO credito (
                numero_credito,
                numero_nfse,
                data_constituicao,
                valor_issqn,
                tipo_credito,
                simples_nacional,
                aliquota,
                valor_faturado,
                valor_deducao,
                base_calculo,
                status,
                nome_solicitante,
                comprovante_url,
                data_solicitacao,
                comentario_analise,
                data_analise
            )
            SELECT 
                sc.numero_credito,
                COALESCE(sc.numero_nfse, 'MIGRATED-NFSE-' || sc.id::VARCHAR) as numero_nfse,
                COALESCE(sc.data_constituicao, CURRENT_DATE) as data_constituicao,
                COALESCE(sc.valor_issqn, 0) as valor_issqn,
                COALESCE(sc.tipo_credito, 'ISSQN') as tipo_credito,
                COALESCE(sc.simples_nacional, false) as simples_nacional,
                COALESCE(sc.aliquota, 0) as aliquota,
                COALESCE(sc.valor_faturado, 0) as valor_faturado,
                COALESCE(sc.valor_deducao, 0) as valor_deducao,
                COALESCE(sc.base_calculo, 0) as base_calculo,
                COALESCE(sc.status, 'EM_ANALISE') as status,
                sc.nome_solicitante,
                sc.comprovante_url,
                sc.data_solicitacao,
                sc.comentario_analise,
                sc.data_analise
            FROM solicitacao_credito sc
            WHERE sc.numero_credito IS NOT NULL
            AND NOT EXISTS (
                SELECT 1 
                FROM credito c 
                WHERE c.numero_credito = sc.numero_credito
            );
        </sql>

        <rollback>
            <!-- Rollback: remover registros migrados nesta migration -->
            <!-- Remove apenas registros que foram inseridos nesta migration -->
            <!-- Identificados pelo numero_credito que existe em solicitacao_credito -->
            <!-- e que não existiam em credito antes desta migration -->
            <!-- ATENÇÃO: Rollback manual pode ser necessário se houver sobreposição de dados -->
            <sql>
                DELETE FROM credito 
                WHERE numero_credito IN (
                    SELECT numero_credito 
                    FROM solicitacao_credito
                    WHERE numero_credito IS NOT NULL
                );
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>

